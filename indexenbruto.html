<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aplicaci√≥n de Sorteos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* =====================
       N√∫cleo de tema (CSS vars)
       ===================== */
        :root {
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --border-color: #3b82f6;
            --text-light: #cbd5e1;
            --text-accent: #93c5fd;
            --accent-gradient-start: #3b82f6;
            --accent-gradient-end: #60a5fa;
            --radius: 12px;
            --font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-dark);
            color: var(--text-light);
            display: grid;
            place-items: start center;
            padding: 24px;
        }

        .container {
            width: 100%;
            max-width: 980px;
        }

        .stack {
            display: grid;
            gap: 24px;
        }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, .25), 0 8px 10px -6px rgba(0, 0, 0, .2);
        }

        .app-header {
            display: grid;
            justify-items: center;
            gap: 12px;
            text-align: center;
        }

        .logo {
            width: 80px;
            height: 80px;
            color: var(--text-accent);
            border-radius: 16px;
            overflow: hidden;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        h1 {
            color: #fff;
            font-size: 2rem;
        }

        h2 {
            color: var(--text-accent);
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        p {
            color: var(--text-light);
            opacity: .95;
        }

        /* Botones */
        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: .5rem;
            width: 100%;
            padding: 14px 16px;
            font-weight: 700;
            background: linear-gradient(to right, var(--accent-gradient-start), var(--accent-gradient-end));
            color: #fff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 15px -5px rgba(59, 130, 246, .5);
            transition: transform .2s, box-shadow .2s, opacity .2s;
        }

        .button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -5px rgba(59, 130, 246, .6);
        }

        .button:disabled {
            background: #334155;
            box-shadow: none;
            cursor: not-allowed;
        }

        .buttons {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .button.ghost {
            background: transparent;
            border: 1px solid var(--border-color);
            box-shadow: none;
        }

        /* Inputs */
        .form-grid {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .form-grid.full {
            grid-template-columns: 1fr;
        }

        .field {
            display: grid;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: var(--text-accent);
        }

        input[type="text"],
        input[type="number"],
        input[type="file"],
        input[type="color"],
        select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-dark);
            color: var(--text-light);
            font-size: .95rem;
        }

        input[type="file"]::file-selector-button {
            background: linear-gradient(to right, var(--accent-gradient-start), var(--accent-gradient-end));
            color: #fff;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform .2s;
        }

        input[type="file"]::file-selector-button:hover {
            transform: scale(1.04);
        }

        /* Animaci√≥n sorteos */
        #main-draw-panel {
            display: none;
        }

        #animation-area {
            display: none;
            height: 150px;
            overflow: hidden;
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            margin: 16px 0;
            position: relative;
            padding: 16px;
        }

        #animation-area::before,
        #animation-area::after {
            content: "";
            position: absolute;
            left: 0;
            width: 100%;
            height: 40px;
            z-index: 2;
        }

        #animation-area::before {
            top: 0;
            background: linear-gradient(to bottom, var(--bg-panel), transparent);
        }

        #animation-area::after {
            bottom: 0;
            background: linear-gradient(to top, var(--bg-panel), transparent);
        }

        #roulette {
            font-size: 2rem;
            font-weight: 800;
            color: #fff;
            position: absolute;
            width: 100%;
            text-align: center;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
        }

        #status-text {
            color: var(--text-accent);
            font-size: 1rem;
            font-weight: 700;
            margin: 0 0 6px;
        }

        /* Resultados */
        #results-panel {
            display: none;
        }

        #results-image {
            background: var(--bg-panel);
            padding: 24px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
        }

        .results-grid {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        @media (max-width: 680px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        .results-list {
            list-style: none;
            display: grid;
            gap: 8px;
        }

        .results-list h3 {
            color: var(--text-accent);
            margin-bottom: 8px;
            font-size: 1.1rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 6px;
        }

        .results-list li {
            background: var(--bg-dark);
            padding: 10px 12px;
            border-radius: 8px;
            font-weight: 600;
        }

        .number {
            color: var(--text-accent);
            font-weight: 800;
            margin-right: 8px;
        }

        /* Drawer Configuraci√≥n */
        .config-toggle {
            position: fixed;
            right: 16px;
            bottom: 16px;
            z-index: 50;
            width: auto;
            min-width: 56px;
        }

        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            width: min(420px, 100%);
            background: var(--bg-panel);
            border-left: 1px solid var(--border-color);
            transform: translateX(100%);
            transition: transform .3s ease;
            z-index: 40;
            display: grid;
            grid-template-rows: auto 1fr auto;
        }

        .drawer.open {
            transform: translateX(0);
        }

        .drawer header,
        .drawer footer {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .drawer footer {
            border-top: 1px solid var(--border-color);
            border-bottom: none;
        }

        .drawer main {
            padding: 16px;
            overflow: auto;
        }

        .drawer h3 {
            color: #fff;
            font-size: 1.1rem;
        }

        .helper {
            font-size: .85rem;
            opacity: .7;
        }

        .divider {
            height: 1px;
            background: var(--border-color);
            opacity: .5;
            margin: 12px 0;
        }
    </style>
</head>
<body>
    <div class="container stack">
        <div class="panel app-header">
            <div class="logo" id="app-logo" aria-label="logo">
                <!-- Reemplazable por imagen subida -->
                <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                </svg>
            </div>
            <h1 id="app-title">Aplicaci√≥n de Sorteos</h1>
            <p id="app-subtitle">Sube tu lista de participantes y configura el sorteo para empezar.</p>
        </div>

        <!-- Configuraci√≥n del sorteo -->
        <div class="panel" id="config-panel">
            <h2>Configuraci√≥n del sorteo</h2>
            <div class="form-grid full" style="margin-top:8px">
                <div class="field">
                    <label for="participants-file">1. Cargar archivo (.txt o .csv: Nombre,Participaciones)</label>
                    <input type="file" id="participants-file" accept=".txt,.csv" />
                    <span class="helper">Ejemplo: <code>Mar√≠a,3</code></span>
                </div>
            </div>
            <div class="form-grid" style="margin-top:8px">
                <div class="field">
                    <label for="winners-count">2. N√∫mero de ganadores</label>
                    <input type="number" id="winners-count" value="1" min="1" />
                </div>
                <div class="field">
                    <label for="alternates-count">3. N√∫mero de suplentes</label>
                    <input type="number" id="alternates-count" value="1" min="0" />
                </div>
            </div>
            <div class="buttons" style="margin-top:12px">
                <button id="draw-button" class="button" disabled>¬°Realizar sorteo!</button>
                <button id="clear-button" class="button ghost" title="Limpiar datos">Limpiar</button>
            </div>
        </div>

        <!-- Animaci√≥n y estado -->
        <div class="panel" id="main-draw-panel">
            <div id="status-text"></div>
            <div id="animation-area">
                <div id="roulette">Preparando...</div>
            </div>
        </div>

        <!-- Resultados -->
        <div class="panel" id="results-panel">
            <div id="results-image">
                <div id="cloned-logo-container" style="display:none; text-align:center; margin-bottom: 12px;"></div>
                <h2 id="results-title">üèÜ ¬°Resultados del Sorteo! ‚ú®</h2>
                <div class="results-grid">
                    <div id="winners-list-container"></div>
                    <div id="alternates-list-container"></div>
                </div>
            </div>
            <div class="buttons" style="margin-top:16px">
                <button id="download-button" class="button">Descargar imagen</button>
                <button id="restart-button" class="button ghost">Nuevo sorteo</button>
            </div>
        </div>
    </div>

    <!-- Toggle y Drawer de configuraci√≥n de marca/tema -->
    <button class="button config-toggle" id="open-config"><span>‚öôÔ∏è</span> Configurar</button>
    <aside class="drawer" id="config-drawer" aria-hidden="true">
        <header>
            <h3>Configuraci√≥n de marca & tema</h3>
            <p class="helper">Los cambios se guardan en <b>localStorage</b> (JSON). Puedes exportar/importar.</p>
        </header>
        <main>
            <section>
                <h2>Identidad</h2>
                <div class="form-grid">
                    <div class="field">
                        <label for="title-input">T√≠tulo</label>
                        <input type="text" id="title-input" placeholder="Aplicaci√≥n de Sorteos" />
                    </div>
                    <div class="field">
                        <label for="subtitle-input">Subt√≠tulo</label>
                        <input type="text" id="subtitle-input" placeholder="Sube tu lista de participantes..." />
                    </div>
                </div>
                <div class="form-grid full" style="margin-top:8px">
                    <div class="field">
                        <label for="logo-input">Logo (PNG/JPG/SVG)</label>
                        <input type="file" id="logo-input" accept="image/*" />
                        <span class="helper">Se incrusta como Data URL y se incluye en la exportaci√≥n JSON.</span>
                    </div>
                </div>
            </section>
            <div class="divider"></div>
            <section>
                <h2>Colores</h2>
                <div class="form-grid">
                    <div class="field"><label>Fondo (oscuro)</label><input type="color" id="c-bg-dark"></div>
                    <div class="field"><label>Panel</label><input type="color" id="c-bg-panel"></div>
                    <div class="field"><label>Borde/Primario</label><input type="color" id="c-border"></div>
                    <div class="field"><label>Texto claro</label><input type="color" id="c-text-light"></div>
                    <div class="field"><label>Texto acento</label><input type="color" id="c-text-accent"></div>
                    <div class="field"><label>Gradiente A</label><input type="color" id="c-grad-a"></div>
                    <div class="field"><label>Gradiente B</label><input type="color" id="c-grad-b"></div>
                </div>
            </section>
            <div class="divider"></div>
            <section>
                <h2>Apariencia</h2>
                <div class="form-grid">
                    <div class="field">
                        <label for="radius-input">Radio esquinas (px)</label>
                        <input type="number" id="radius-input" min="0" max="32" step="1" />
                    </div>
                    <div class="field">
                        <label for="font-select">Fuente</label>
                        <select id="font-select">
                            <option value='"Segoe UI", Tahoma, Geneva, Verdana, sans-serif'>Sistema</option>
                            <option
                                value='Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"'>
                                Inter (fallback)</option>
                            <option value='"Gill Sans", "Gill Sans MT", Calibri, "Trebuchet MS", sans-serif'>Gill Sans
                            </option>
                        </select>
                    </div>
                </div>
            </section>
            <div class="divider"></div>
            <section>
                <h2>Preferencias</h2>
                <div class="form-grid full">
                    <div class="field">
                        <label><input type="checkbox" id="show-animation" /> Mostrar animaci√≥n de ruleta</label>
                    </div>
                    <div class="field">
                        <label><input type="checkbox" id="show-logo-in-result" /> Mostrar logo en la imagen de
                            resultados</label>
                    </div>
                    <div class="field">
                        <label><input type="checkbox" id="weighted-by-tickets" checked /> Selecci√≥n ponderada por
                            participaciones</label>
                    </div>
                </div>
            </section>
        </main>
        <footer>
            <div class="buttons">
                <button id="save-config" class="button">Guardar</button>
                <button id="reset-config" class="button ghost">Restablecer</button>
            </div>
            <div class="buttons" style="margin-top:8px">
                <button id="export-config" class="button ghost">Exportar JSON</button>
                <label class="button ghost" style="cursor:pointer; text-align:center">
                    Importar JSON
                    <input id="import-config" type="file" accept="application/json" style="display:none" />
                </label>
            </div>
        </footer>
    </aside>

    <script>
        // ======================
        // Estado & Configuraci√≥n
        // ======================
        const STORAGE_KEY = "raffleAppConfig.v1";

        const defaultConfig = {
            title: "Aplicaci√≥n de Sorteos",
            subtitle: "Sube tu lista de participantes y configura el sorteo para empezar.",
            logoDataUrl: null, // Data URL si el usuario sube imagen
            theme: {
                bgDark: "#0f172a",
                bgPanel: "#1e293b",
                border: "#3b82f6",
                textLight: "#cbd5e1",
                textAccent: "#93c5fd",
                gradA: "#3b82f6",
                gradB: "#60a5fa",
                radius: 12,
                font: '"Segoe UI", Tahoma, Geneva, Verdana, sans-serif'
            },
            prefs: {
                showAnimation: true,
                showLogoInResult: true,
                weightedByTickets: true
            }
        };

        let appState = {
            tickets: [],                // array de tickets (nombres repetidos)
            uniqueParticipants: [],     // nombres √∫nicos
            counts: new Map(),          // nombre -> n¬∫ participaciones
            config: loadConfig()
        };

        function loadConfig() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return structuredClone(defaultConfig);
                const parsed = JSON.parse(raw);
                // merge superficial con defaults para compatibilidad
                return {
                    ...structuredClone(defaultConfig),
                    ...parsed,
                    theme: { ...defaultConfig.theme, ...(parsed.theme || {}) },
                    prefs: { ...defaultConfig.prefs, ...(parsed.prefs || {}) }
                };
            } catch (e) {
                console.warn("Config corrupta, usando defaults", e);
                return structuredClone(defaultConfig);
            }
        }

        function saveConfig(cfg = appState.config) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(cfg));
        }

        function applyTheme(cfg = appState.config) {
            const r = document.documentElement.style;
            r.setProperty('--bg-dark', cfg.theme.bgDark);
            r.setProperty('--bg-panel', cfg.theme.bgPanel);
            r.setProperty('--border-color', cfg.theme.border);
            r.setProperty('--text-light', cfg.theme.textLight);
            r.setProperty('--text-accent', cfg.theme.textAccent);
            r.setProperty('--accent-gradient-start', cfg.theme.gradA);
            r.setProperty('--accent-gradient-end', cfg.theme.gradB);
            r.setProperty('--radius', cfg.theme.radius + 'px');
            r.setProperty('--font-family', cfg.theme.font);

            document.getElementById('app-title').textContent = cfg.title || defaultConfig.title;
            document.getElementById('app-subtitle').textContent = cfg.subtitle || defaultConfig.subtitle;

            const logoContainer = document.getElementById('app-logo');
            logoContainer.innerHTML = '';
            if (cfg.logoDataUrl) {
                const img = document.createElement('img');
                img.src = cfg.logoDataUrl; img.alt = 'logo';
                logoContainer.appendChild(img);
            } else {
                // SVG por defecto
                logoContainer.innerHTML = `
          <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
          </svg>`;
            }
        }

        // ==========
        // Utilidades
        // ==========
        function parseParticipantsText(text) {
            const tickets = [];
            const counts = new Map();
            const unique = new Set();

            const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
            for (const line of lines) {
                const [rawName, rawCount] = line.split(/,|;|\t/); // soporta coma, punto y coma, tab
                if (!rawName) continue;
                const name = rawName.trim();
                let count = parseInt((rawCount || '1').trim(), 10);
                if (!Number.isFinite(count) || count < 1) count = 1;

                unique.add(name);
                counts.set(name, (counts.get(name) || 0) + count);
                for (let i = 0; i < count; i++) tickets.push(name);
            }
            return { tickets, uniqueParticipants: Array.from(unique), counts };
        }

        function download(filename, dataUrl) {
            const a = document.createElement('a');
            a.href = dataUrl; a.download = filename; a.click();
        }

        function fileToDataUrl(file) {
            return new Promise((resolve, reject) => {
                const fr = new FileReader();
                fr.onload = () => resolve(fr.result);
                fr.onerror = reject;
                fr.readAsDataURL(file);
            });
        }

        // ========================
        // Elementos del documento
        // ========================
        const $ = (sel) => document.querySelector(sel);

        const el = {
            file: $('#participants-file'),
            winners: $('#winners-count'),
            alternates: $('#alternates-count'),
            drawBtn: $('#draw-button'),
            clearBtn: $('#clear-button'),
            configPanel: $('#config-panel'),
            mainPanel: $('#main-draw-panel'),
            anim: $('#animation-area'),
            roulette: $('#roulette'),
            status: $('#status-text'),
            resultsPanel: $('#results-panel'),
            winnersList: $('#winners-list-container'),
            alternatesList: $('#alternates-list-container'),
            resultsImage: $('#results-image'),
            downloadBtn: $('#download-button'),
            restartBtn: $('#restart-button'),
            clonedLogoContainer: $('#cloned-logo-container'),

            // Drawer config
            drawer: $('#config-drawer'),
            openConfig: $('#open-config'),
            saveConfig: $('#save-config'),
            resetConfig: $('#reset-config'),
            exportConfig: $('#export-config'),
            importConfig: $('#import-config'),

            // Campos config
            title: $('#title-input'),
            subtitle: $('#subtitle-input'),
            logo: $('#logo-input'),
            cBgDark: $('#c-bg-dark'),
            cBgPanel: $('#c-bg-panel'),
            cBorder: $('#c-border'),
            cTextLight: $('#c-text-light'),
            cTextAccent: $('#c-text-accent'),
            cGradA: $('#c-grad-a'),
            cGradB: $('#c-grad-b'),
            radius: $('#radius-input'),
            font: $('#font-select'),
            pShowAnim: $('#show-animation'),
            pShowLogo: $('#show-logo-in-result'),
            pWeighted: $('#weighted-by-tickets'),
        };

        // =====================
        // Inicializaci√≥n UI
        // =====================
        applyTheme(appState.config);
        hydrateConfigForm(appState.config);

        function hydrateConfigForm(cfg) {
            el.title.value = cfg.title;
            el.subtitle.value = cfg.subtitle;
            el.cBgDark.value = cfg.theme.bgDark;
            el.cBgPanel.value = cfg.theme.bgPanel;
            el.cBorder.value = cfg.theme.border;
            el.cTextLight.value = cfg.theme.textLight;
            el.cTextAccent.value = cfg.theme.textAccent;
            el.cGradA.value = cfg.theme.gradA;
            el.cGradB.value = cfg.theme.gradB;
            el.radius.value = cfg.theme.radius;
            el.font.value = cfg.theme.font;
            el.pShowAnim.checked = cfg.prefs.showAnimation;
            el.pShowLogo.checked = cfg.prefs.showLogoInResult;
            el.pWeighted.checked = cfg.prefs.weightedByTickets;
        }

        function readConfigForm() {
            return {
                ...appState.config,
                title: el.title.value.trim() || defaultConfig.title,
                subtitle: el.subtitle.value.trim() || defaultConfig.subtitle,
                theme: {
                    ...appState.config.theme,
                    bgDark: el.cBgDark.value,
                    bgPanel: el.cBgPanel.value,
                    border: el.cBorder.value,
                    textLight: el.cTextLight.value,
                    textAccent: el.cTextAccent.value,
                    gradA: el.cGradA.value,
                    gradB: el.cGradB.value,
                    radius: parseInt(el.radius.value, 10) || defaultConfig.theme.radius,
                    font: el.font.value
                },
                prefs: {
                    ...appState.config.prefs,
                    showAnimation: el.pShowAnim.checked,
                    showLogoInResult: el.pShowLogo.checked,
                    weightedByTickets: el.pWeighted.checked
                }
            }
        }

        // Toggle drawer
        el.openConfig.addEventListener('click', () => {
            el.drawer.classList.toggle('open');
            el.drawer.setAttribute('aria-hidden', el.drawer.classList.contains('open') ? 'false' : 'true');
        });

        // Guardar
        el.saveConfig.addEventListener('click', async () => {
            const cfg = readConfigForm();
            // Logo (si se seleccion√≥ ahora)
            if (el.logo.files && el.logo.files[0]) {
                try {
                    cfg.logoDataUrl = await fileToDataUrl(el.logo.files[0]);
                } catch (e) { console.error('Error leyendo logo', e); }
            }
            appState.config = cfg; saveConfig(cfg); applyTheme(cfg);
        });

        // Restablecer
        el.resetConfig.addEventListener('click', () => {
            if (!confirm('¬øRestablecer configuraci√≥n a valores por defecto?')) return;
            appState.config = structuredClone(defaultConfig);
            saveConfig(appState.config);
            hydrateConfigForm(appState.config);
            applyTheme(appState.config);
        });

        // Exportar JSON
        el.exportConfig.addEventListener('click', () => {
            const blob = new Blob([JSON.stringify(appState.config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            download('config-sorteos.json', url);
            setTimeout(() => URL.revokeObjectURL(url), 5000);
        });

        // Importar JSON
        el.importConfig.addEventListener('change', () => {
            const f = el.importConfig.files?.[0]; if (!f) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const parsed = JSON.parse(reader.result);
                    appState.config = {
                        ...structuredClone(defaultConfig),
                        ...parsed,
                        theme: { ...defaultConfig.theme, ...(parsed.theme || {}) },
                        prefs: { ...defaultConfig.prefs, ...(parsed.prefs || {}) }
                    };
                    saveConfig(appState.config);
                    hydrateConfigForm(appState.config);
                    applyTheme(appState.config);
                    alert('Configuraci√≥n importada.');
                } catch (e) {
                    alert('JSON inv√°lido');
                }
            };
            reader.readAsText(f);
        });

        // =====================
        // Carga de participantes
        // =====================
        el.file.addEventListener('change', (ev) => {
            const file = ev.target.files?.[0];
            if (!file) { el.drawBtn.disabled = true; return; }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const { tickets, uniqueParticipants, counts } = parseParticipantsText(String(e.target.result));
                    appState.tickets = tickets;
                    appState.uniqueParticipants = uniqueParticipants;
                    appState.counts = counts;
                    el.drawBtn.disabled = tickets.length === 0;
                } catch (err) {
                    console.error(err);
                    alert('Error al procesar el archivo.');
                    el.drawBtn.disabled = true;
                }
            };
            reader.onerror = () => { alert('Error al leer el archivo.'); el.drawBtn.disabled = true; };
            reader.readAsText(file);
        });

        // =====================
        // L√≥gica del sorteo
        // =====================
        el.drawBtn.addEventListener('click', () => {
            const numWinners = parseInt(el.winners.value, 10);
            const numAlternates = parseInt(el.alternates.value, 10);
            if (!Number.isFinite(numWinners) || numWinners < 1) { alert('El n√∫mero de ganadores debe ser al menos 1.'); return; }
            if ((numWinners + numAlternates) > appState.uniqueParticipants.length) {
                alert('Ganadores + suplentes no puede ser mayor que el n√∫mero de participantes √∫nicos.');
                return;
            }

            // Oculta config y muestra animaci√≥n si procede
            el.configPanel.style.display = 'none';
            el.mainPanel.style.display = 'block';
            if (appState.config.prefs.showAnimation) el.anim.style.display = 'block';

            runDrawSequence(numWinners, numAlternates);
        });

        el.clearBtn.addEventListener('click', () => {
            appState.tickets = []; appState.uniqueParticipants = []; appState.counts = new Map();
            el.file.value = ''; el.drawBtn.disabled = true;
            alert('Datos limpiados.');
        });

        el.restartBtn.addEventListener('click', () => {
            // Vuelve al panel inicial
            el.resultsPanel.style.display = 'none';
            el.configPanel.style.display = 'block';
            el.mainPanel.style.display = 'none';
            el.anim.style.display = 'none';
        });

        async function runDrawSequence(numWinners, numAlternates) {
            const winners = [];
            const alternates = [];

            // Copias mutables
            let availableNames = new Set(appState.uniqueParticipants);
            let workingTickets = appState.config.prefs.weightedByTickets
                ? appState.tickets.slice() // ponderado
                : appState.uniqueParticipants.slice(); // no ponderado

            // helper para eliminar todas las ocurrencias de un nombre en workingTickets
            const pruneName = (name) => {
                if (Array.isArray(workingTickets)) {
                    workingTickets = workingTickets.filter(n => n !== name);
                } else {
                    workingTickets = workingTickets.filter(n => n !== name);
                }
                availableNames.delete(name);
            };

            // Selecci√≥n gen√©rica
            const pickOne = async (label, total) => {
                el.status.textContent = `${label} ${(label.includes('GANADOR') ? winners.length : alternates.length) + 1} de ${total}...`;
                let selected;

                if (appState.config.prefs.showAnimation) {
                    selected = await animateAndPick(workingTickets);
                } else {
                    // selecci√≥n instant√°nea
                    selected = workingTickets[Math.floor(Math.random() * workingTickets.length)];
                }

                // Garantiza que el nombre est√© disponible (por si workingTickets tuviera restos)
                if (!availableNames.has(selected)) {
                    // si cae en uno ya usado, forzar otro
                    const pool = Array.from(availableNames);
                    selected = pool[Math.floor(Math.random() * pool.length)];
                }
                pruneName(selected);
                return selected;
            };

            // Ganadores
            for (let i = 0; i < numWinners; i++) {
                winners.push(await pickOne('SELECCIONANDO GANADOR/A', numWinners));
            }
            // Suplentes
            for (let i = 0; i < numAlternates; i++) {
                alternates.push(await pickOne('SELECCIONANDO SUPLENTE', numAlternates));
            }

            displayResults(winners, alternates);
        }

        function animateAndPick(pool) {
            return new Promise(resolve => {
                const animationDuration = 2800;
                const fastInterval = 45;
                const slowDownStart = animationDuration - 1400;

                const spin = setInterval(() => {
                    el.roulette.textContent = pool[Math.floor(Math.random() * pool.length)] || '...';
                }, fastInterval);

                setTimeout(() => {
                    clearInterval(spin);
                    const selected = pool[Math.floor(Math.random() * pool.length)];
                    const slowIntervals = [90, 160, 250, 380, 520];
                    let idx = 0;
                    (function slow() {
                        el.roulette.textContent = pool[Math.floor(Math.random() * pool.length)] || '...';
                        if (idx < slowIntervals.length) {
                            setTimeout(slow, slowIntervals[idx++]);
                        } else {
                            el.roulette.textContent = selected;
                            setTimeout(() => resolve(selected), 900);
                        }
                    })();
                }, slowDownStart);
            });
        }

        // =====================
        // Resultados & Exportar
        // =====================
        function displayResults(winners, alternates) {
            el.mainPanel.style.display = 'none';
            el.resultsPanel.style.display = 'block';

            let wHtml = '<h3>üèÜ GANADORES</h3><ul class="results-list">';
            winners.forEach((n, i) => wHtml += `<li><span class="number">${i + 1}.</span> ${n}</li>`);
            wHtml += '</ul>';
            el.winnersList.innerHTML = wHtml;

            if (alternates.length) {
                let aHtml = '<h3>‚ú® SUPLENTES</h3><ul class="results-list">';
                alternates.forEach((n, i) => aHtml += `<li><span class="number">${i + 1}.</span> ${n}</li>`);
                aHtml += '</ul>';
                el.alternatesList.innerHTML = aHtml;
            } else {
                el.alternatesList.innerHTML = '';
            }
        }

        el.downloadBtn.addEventListener('click', () => {
            // logo opcional dentro de la imagen
            const logoWrap = el.clonedLogoContainer;
            logoWrap.innerHTML = '';
            if (appState.config.prefs.showLogoInResult) {
                const original = document.getElementById('app-logo');
                const clone = original.cloneNode(true);
                clone.style.margin = '0 auto 12px';
                clone.style.display = 'inline-block';
                logoWrap.appendChild(clone);
                logoWrap.style.display = 'block';
            } else {
                logoWrap.style.display = 'none';
            }

            const options = {
                scale: 2,
                useCORS: true,
                backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-panel').trim(),
            };

            html2canvas(el.resultsImage, options).then(canvas => {
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    download('resultados-sorteo.png', url);
                    URL.revokeObjectURL(url);
                });
                logoWrap.style.display = 'none';
            }).catch(err => {
                console.error('Error al generar la imagen', err);
                alert('Hubo un error al generar la imagen.');
                logoWrap.style.display = 'none';
            });
        });
    </script>
</body>
</html>